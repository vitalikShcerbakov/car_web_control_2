<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Car Control</title>
<style>
body {
  font-family: sans-serif;
  background: #111;
  color: #fff;
  text-align: center;
}

button {
  width: 100px;
  height: 60px;
  margin: 10px;
  font-size: 18px;
}

.speed-control {
  margin: 20px 0;
  padding: 15px;
  background: #222;
  border-radius: 10px;
}

.speed-control label {
  display: block;
  margin-bottom: 10px;
  font-size: 18px;
}

.speed-control input {
  width: 300px;
  height: 10px;
  border-radius: 5px;
  background: #333;
  outline: none;
}

.speed-control span {
  display: inline-block;
  min-width: 50px;
  padding: 5px 15px;
  margin-left: 10px;
  background: #333;
  border-radius: 5px;
  font-size: 18px;
  font-weight: bold;
  color: #4CAF50;
}
</style>
</head>
<body>

<h2>üì∑ –ö–∞–º–µ—Ä–∞</h2>
<img src="/video" width="640" height="480">


<!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç—å—é -->
<div class="speed-control">
  <label>‚ö° –†–µ–≥—É–ª–∏—Ä–æ–≤–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ <span id="speedValue">150</span></label>
  <input type="range" id="speedSlider" min="0" max="255" value="150" step="5">
  <div style="margin-top: 10px; font-size: 14px; color: #888;">
    –¢–µ–∫—É—â–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å: <span id="currentSpeed">150</span>
  </div>
</div>

<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ raspberyy, –∞–∫–±  -->
<div class="status-panel" style="margin-top:20px; background:#222; padding:15px; border-radius:10px;">
  <h3>üîã –°—Ç–∞—Ç—É—Å –±–∞—Ç–∞—Ä–µ–π</h3>
  BAT1: <span id="bat1">--</span><br>
  BAT2: <span id="bat2">--</span><br>
  UPS:  <span id="ups">--</span>

  <h3>üå°Ô∏è Raspberry Pi</h3>
  CPU Temp: <span id="cpuTemp">--</span><br>
  CPU Load: <span id="cpuLoad">--</span><br>
  RAM: <span id="ramLoad">--</span><br>
  Disk: <span id="diskLoad">--</span>
</div>

<div>
  <button onclick="sendWithSpeed(150, 0)">‚Üë</button>
</div>
<div>
  <button onclick="sendWithSpeed(0, -150)">‚Üê</button>
  <button onclick="sendWithSpeed(0, 0)">‚ñ†</button>
  <button onclick="sendWithSpeed(0, 150)">‚Üí</button>
</div>
<div>
  <button onclick="sendWithSpeed(-150, 0)">‚Üì</button>
</div>

<script>
const ws = new WebSocket(`ws://${location.host}/ws`);
let gas = 0;
let steer = 0;
let currentSpeed = 150; // —Ç–µ–∫—É—â–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 150)


// –û–±—ä–µ–∫—Ç –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö
let statusData = {};

// –ö–æ–≥–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ
ws.onmessage = (event) => {
    try {
        statusData = JSON.parse(event.data);

        // –û–±–Ω–æ–≤–ª—è–µ–º DOM —Å –±–∞—Ç–∞—Ä–µ—è–º–∏
        if (statusData.battery) {
            document.getElementById("bat1").textContent = statusData.battery.bat1.toFixed(2) + " V";
            document.getElementById("bat2").textContent = statusData.battery.bat2.toFixed(2) + " V";
            document.getElementById("ups").textContent  = statusData.battery.ups.toFixed(2)  + " V";
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º DOM —Å —Å–∏—Å—Ç–µ–º–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
        if (statusData.raspi_temp !== undefined) {
            document.getElementById("cpuTemp").textContent = statusData.raspi_temp.toFixed(1) + " ¬∞C";
        }
        if (statusData.cpu !== undefined) {
            document.getElementById("cpuLoad").textContent = statusData.cpu.toFixed(1) + " %";
        }
        if (statusData.memory !== undefined) {
            document.getElementById("ramLoad").textContent = statusData.memory.toFixed(1) + " %";
        }
        if (statusData.disk !== undefined) {
            document.getElementById("diskLoad").textContent = statusData.disk.toFixed(1) + " %";
        }
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON:", e, event.data);
    }
};


// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏
function updateSpeedDisplay() {
  document.getElementById('speedValue').textContent = currentSpeed;
  document.getElementById('currentSpeed').textContent = currentSpeed;
}

// –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å —É—á–µ—Ç–æ–º —Ç–µ–∫—É—â–µ–π —Å–∫–æ—Ä–æ—Å—Ç–∏
function sendWithSpeed(g, s) {
  // –ï—Å–ª–∏ g –∏–ª–∏ s –Ω–µ –Ω—É–ª–µ–≤—ã–µ, –ø—Ä–∏–º–µ–Ω—è–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–∫–æ—Ä–æ—Å—Ç–∏
  if (g !== 0 || s !== 0) {
    // –í—ã—á–∏—Å–ª—è–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –±–∞–∑–æ–≤–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ 150
    const speedMultiplier = currentSpeed / 150;
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∏ –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ —Ü–µ–ª–æ–≥–æ —á–∏—Å–ª–∞
    g = Math.round(g * speedMultiplier);
    s = Math.round(s * speedMultiplier);
  }
  
  gas = g;
  steer = s;
  ws.send(JSON.stringify({ gas, steer }));
}

// WSAD —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å —É—á–µ—Ç–æ–º —Å–∫–æ—Ä–æ—Å—Ç–∏
document.addEventListener("keydown", e => {
  if (e.repeat) return;

  if (e.key === "w") sendWithSpeed(150, steer);
  if (e.key === "s") sendWithSpeed(-150, steer);
  if (e.key === "a") sendWithSpeed(gas, -150);
  if (e.key === "d") sendWithSpeed(gas, 150);
});

document.addEventListener("keyup", e => {
  if (["w","s"].includes(e.key)) gas = 0;
  if (["a","d"].includes(e.key)) steer = 0;
  sendWithSpeed(gas, steer);
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª–∑—É–Ω–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏
document.getElementById('speedSlider').addEventListener('input', function(e) {
  currentSpeed = parseInt(e.target.value);
  updateSpeedDisplay();
  
  // –ï—Å–ª–∏ –º–∞—à–∏–Ω–∫–∞ —Å–µ–π—á–∞—Å –¥–≤–∏–∂–µ—Ç—Å—è, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –Ω–∞ –ª–µ—Ç—É
  if (gas !== 0 || steer !== 0) {
    sendWithSpeed(gas, steer);
  }
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
updateSpeedDisplay();

// –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ –∫–æ–Ω—Å–æ–ª–∏ —Ç–µ–∫—É—â—É—é —Å–∫–æ—Ä–æ—Å—Ç—å
console.log('–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–æ! –¢–µ–∫—É—â–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å:', currentSpeed);
</script>

</body>
</html>
